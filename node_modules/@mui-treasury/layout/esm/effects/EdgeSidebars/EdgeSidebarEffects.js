import { createPermanentSidebarEffect } from '../PermanentSidebar';
import { createPersistentSidebarEffect } from '../PersistentSidebar';
import { isPermanentSidebarConfig, isPersistentSidebarConfig } from '../../utils/sidebarChecker';
import { pickNearestBreakpoint } from '../../utils';
export var getEdgeSidebarEffect = function getEdgeSidebarEffect(state, config) {
  if (isPermanentSidebarConfig(config)) {
    return createPermanentSidebarEffect(config, state);
  } else if (isPersistentSidebarConfig(config)) {
    return createPersistentSidebarEffect(config, state);
  }

  return undefined;
};
export default (function (state, edgeSidebar) {
  var configMap = edgeSidebar.configMap,
      configMapById = edgeSidebar.configMapById,
      sidebarIds = edgeSidebar.sidebarIds;
  var breakpoints = Object.keys(configMap);
  var effectsMap = {};
  breakpoints.forEach(function (bp) {
    effectsMap[bp] = []; // iterate all sidebars

    sidebarIds.forEach(function (aSidebarId) {
      var config = pickNearestBreakpoint(configMapById[aSidebarId], bp);
      var effect = getEdgeSidebarEffect(state, config);
      if (effect) effectsMap[bp].push(effect);
    });
  });
  return {
    iterateBreakpointEffects: function iterateBreakpointEffects(inputs, getEffects) {
      var foundAllSidebars = false;
      var sidebarCount = sidebarIds.length;
      inputs.forEach(function (bp) {
        var effects = pickNearestBreakpoint(effectsMap, bp);

        if (effects) {
          if (!foundAllSidebars && effects.length === sidebarCount) {
            foundAllSidebars = true;
          }

          if (foundAllSidebars && effects.length < sidebarCount) {
            // attach all
            var existingIds = effects.map(function (_ref) {
              var id = _ref.id;
              return id;
            });
            var missingIds = sidebarIds.filter(function (id) {
              return !existingIds.includes(id);
            });
            missingIds.forEach(function (id) {
              effects.push(getEdgeSidebarEffect(state, pickNearestBreakpoint(configMapById[id], bp)));
            });
          }

          getEffects(bp, effects);
        } else {
          getEffects(bp, []);
        }
      });
    }
  };
});